var H=Object.defineProperty;var z=(n,e,t)=>e in n?H(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var T=(n,e,t)=>z(n,typeof e!="symbol"?e+"":e,t);import{S as I,m as f,b as d}from"./index-Cmg072g4.js";import{z as i,S as v,l as E,m as k,k as _,E as C,g as M,u as P,j as B,F as w,r as Q,e as V,f as W,b as K,a as $,w as G,o as J,h as Z,p as X,d as Y,c as ee,n as te}from"./index-CuSsmBFW.js";const ie=["disconnected","connecting","connected","disconnecting"],se="disconnected",ne=i.object({status:i.enum(ie).optional().describe(v.persist),ipAddress:i.string().optional().describe(v.session),connectionCount:i.number().describe(v.persist),useAutoConnect:i.boolean().optional().describe(v.persist)}).default({connectionCount:0}),oe=new E(ne);class ae extends I{constructor(e){super(),this.connectionStorage=e}get currentIp(){return this.connectionStorage.state.ipAddress}get status(){return this.connectionStorage.state.status??se}get isConnected(){return this.connectionStorage.state.status==="connected"}get connectionCount(){return this.connectionStorage.state.connectionCount}get useAutoConnect(){return!!this.connectionStorage.state.useAutoConnect}async boot(){await this.connectionStorage.sync(),this.bootResolve(),await this.bootPromise}async setIpAddress(e){await this.connectionStorage.setItems({ipAddress:e})}async removeIpAddress(){await this.connectionStorage.removeItems("ipAddress")}async setConnectionStatus(e){await this.connectionStorage.setItems({status:e})}async incrementConnectionCount(){const e=this.connectionStorage.state.connectionCount+1;await this.connectionStorage.setItems({connectionCount:e})}async setAutoConnect(e){await this.connectionStorage.setItems({useAutoConnect:e})}}const ce=new k("connection",oe,_),re=new ae(ce),x="nl";var A=(n=>(n[n.public=0]="public",n[n.private=1]="private",n))(A||{}),R=(n=>(n[n.free=0]="free",n[n.premium=1]="premium",n))(R||{}),ue=(n=>(n.free="free",n.premium="premium",n.custom="custom",n))(ue||{});const le=i.object({id:i.string(),name:i.string(),code:i.string(),phrases:i.string().array()}),he=i.object({id:i.string(),name:i.string(),phrases:i.string().array(),region:i.string(),via:i.string(),target:i.string(),countryCode:i.string(),type:i.nativeEnum(A),proxyType:i.nativeEnum(R)}),de=i.object({region:i.string(),name:i.string(),description:i.string(),countryCode:i.string(),latitude:i.string(),longitude:i.string(),networkLoad:i.string(),priority:i.number(),type:i.nativeEnum(A),proxy_type:i.nativeEnum(R)}),ve=i.object({id:i.string(),type:i.literal(2)}),pe=i.object({id:i.string(),type:i.literal(1),items:ve.array()}),Se=i.object({countries:le.array(),locations:he.array(),items:pe.array()}),me=i.object({data:Se.optional(),updatedAt:i.number()}),ge=i.object({type:i.nativeEnum(A),region:i.string(),regionName:i.string(),countryName:i.string(),countryCode:i.string()}),ye=i.object({activeId:i.string().optional().describe(v.persist),favoriteIds:i.string().array().optional().describe(v.persist),locations:me.optional().describe(v.persist),lastActiveLocationData:ge.optional().describe(v.persist)}).default({}),we=new E(ye);function fe(n){return de.safeParse(n).success}const _e=12*60*60*1e3;class be extends I{constructor(e){super(),this.locationStorage=e}get activeLocation(){var t;return!this.locationStorage.state.activeId||!((t=this.locationStorage.state.locations)!=null&&t.data)?null:this.locationStorage.state.locations.data.locations.find(s=>s.id===this.locationStorage.state.activeId)??null}get activeLocationId(){return this.locationStorage.state.activeId??""}get favoriteLocations(){return this.locationStorage.state.favoriteIds??[]}get locationsData(){var e;return((e=this.locationStorage.state.locations)==null?void 0:e.data)??null}get lastActiveLocation(){return this.locationStorage.state.lastActiveLocationData??null}get needUpdateLocations(){return this.locationStorage.state.locations?this.locationStorage.state.locations.updatedAt+_e<Date.now():!0}get defaultLocationId(){var t;const e=(t=this.locationsData)==null?void 0:t.locations.find(s=>s.region===x);return e==null?void 0:e.id}async boot(){await this.locationStorage.sync(),this.bootResolve(),await this.bootPromise}async setLocationsData(e){await this.locationStorage.setItems({locations:{data:e,updatedAt:Date.now()}})}async setActiveLocation(e){var s,o,r;let t;if(typeof e=="string")t=e;else if(fe(e)){const a=(s=this.locationsData)==null?void 0:s.locations.find(c=>{const u=c.region===e.region,p=c.proxyType===e.proxy_type;return u&&p});t=a==null?void 0:a.id}else{const a=(o=this.locationsData)==null?void 0:o.locations.find(c=>c.region===x);t=a==null?void 0:a.id}if(t?await this.locationStorage.setItems({activeId:t}):await this.locationStorage.removeItems("activeId"),this.activeLocation){const a=(r=this.locationsData)==null?void 0:r.countries.find(u=>u.code===this.activeLocation.countryCode),c={type:this.activeLocation.type,region:this.activeLocation.region,regionName:this.activeLocation.name,countryName:(a==null?void 0:a.name)??"N/A",countryCode:this.activeLocation.countryCode};await this.locationStorage.setItems({lastActiveLocationData:c})}else await this.locationStorage.removeItems("lastActiveLocationData")}async removeActiveLocation(){await this.locationStorage.removeItems("activeId")}async setFavoriteLocations(e){const t=[...new Set([...this.favoriteLocations,...e])];await this.locationStorage.setItems({favoriteIds:t})}async removeFavoriteLocations(e){const t=this.favoriteLocations.filter(s=>!e.includes(s));await this.locationStorage.setItems({favoriteIds:t})}}const Le=new k("location",we,_),q=new be(Le),Ce=i.object({active:i.boolean(),interval:i.number(),count:i.number(),nextTimestamp:i.number(),startedAt:i.number()}),Ae=i.object({showState:Ce.optional().describe(v.session)}).default({}),Te=new E(Ae),De=24*60*60*1e3,Ie=5*1e3,N=[10*1e3,5*60*1e3,15*60*1e3,50*60*1e3];class Ee extends I{constructor(e,t,s,o,r){super(),this.lockScreenStorage=e,this.globalStateService=t,this.messageService=s,this.userService=o,this.abTestsService=r}get active(){const e=this.abTestsService.getExperimentActiveStatus(C.lockScreen),t=this.userService.userType==="free",s=this.globalStateService.installedAt+De,o=Date.now()>s;return e&&t&&o}get showState(){return this.lockScreenStorage.state.showState}async boot(){await this.lockScreenStorage.sync(),this.bootResolve(),await this.bootPromise}async iterateShowState(){const{showState:e}=this.lockScreenStorage.state,t=e?e.count+1:0,s=N[t]??N.at(-1),o=(e==null?void 0:e.startedAt)??Date.now();await this.lockScreenStorage.setItems({showState:{startedAt:o,active:this.active,count:t,interval:Ie,nextTimestamp:Date.now()+s}}),this.messageService.notifyTab({type:"lock-screen-show-state-change",success:!0,data:this.showState})}async removeShowState(){await this.lockScreenStorage.removeItems("showState"),this.messageService.notifyTab({type:"lock-screen-show-state-change",success:!0,data:this.showState})}}const ke=new k("lock-screen",Te,_),Pe=new Ee(ke,M,f,P,B),O="2.1",Re="2.95";class Fe{constructor(e,t,s,o,r,a,c,u,p,h,S){this.globalStateService=e,this.apiFreeService=t,this.apiPremiumService=s,this.userService=o,this.locationService=r,this.accessService=a,this.analyticsService=c,this.messageService=u,this.eventService=p,this.webrtcService=h,this.abTestsService=S,this.eventService.subscribe({"premium-refresh-token-failed":this.premiumRefreshTokenFailedListener.bind(this),"free-refresh-token-failed":this.freeRefreshTokenFailedListener.bind(this)})}async init(){this.apiFreeService.hasTokens||await this.launch()}async launch(){const e=await this.apiFreeService.fetch({method:"POST",url:"apiLaunch",body:{...this.apiFreeService.deviceInfo}});if(!e.success)return await this.criticalErrorOccured({status_code:w.getStatusCodeMessage(e)}),e;await this.apiFreeService.setTokens({accessToken:e.data.accessToken,refreshToken:""});const t=await this.apiFreeService.fetch({method:"POST",url:"apiLocationList"});if(!t.success)return await this.criticalErrorOccured({status_code:w.getStatusCodeMessage(t)}),t;if(await this.locationService.setLocationsData(t.data),!this.locationService.activeLocation)if(this.abTestsService.getExperimentActiveStatus(C.limitLocations))await this.locationService.setActiveLocation(O);else{const o=e.data.user.default.location;await this.locationService.setActiveLocation(o)}return await this.globalStateService.setCriticalError(!1),{success:!0,data:{success:!0}}}async getCriticalError(){return await Promise.resolve(),{success:!0,data:{state:this.globalStateService.criticalError}}}async login(e){var r;const t=await this.apiPremiumService.fetch({method:"POST",url:"authLogin",body:{...this.apiFreeService.deviceInfo,...e}});if(!t.success)return t;await this.apiPremiumService.setTokens({accessToken:t.data.accessToken,refreshToken:t.data.refreshToken});const s=await this.apiPremiumService.fetch({method:"POST",url:"apiLocationList"});if(!s.success)return s;await this.locationService.setLocationsData(s.data),await this.userService.setUser(t.data.user),await this.userService.setSubscription(t.data.user.subscription);const o=await this.apiPremiumService.fetch({method:"GET",url:"apiSubscriptionShield"});if(o.success&&await this.userService.setSubscriptionBundle(o.data),this.userService.userType==="trial"){const a=await this.apiPremiumService.fetch({method:"GET",url:"apiSubscriptionCheckUsedTrial"});if(!a.success){const c={...t.data.user.subscription,status:Q.disabled};await this.userService.setSubscription(c);const u=((r=a.errors[0])==null?void 0:r.message)??"";u&&this.messageService.notifyPopup({type:"toast-message",success:!0,data:{id:"0",message:u,type:"warning"}})}}if(this.userService.hasPermitions("locations","premium")){const a=t.data.user.default.location;await this.locationService.setActiveLocation(a)}else if(this.abTestsService.getExperimentActiveStatus(C.limitLocations))await this.locationService.setActiveLocation(Re);else{const c=this.locationService.defaultLocationId;await this.locationService.setActiveLocation(c)}return await this.syncSubscriptionSlots(),this.webrtcService.needEnableWebrtc&&this.webrtcService.enable().catch(()=>{}),{success:!0,data:{success:!0}}}async logout(){const e=await this.apiPremiumService.fetch({method:"POST",url:"authLogout"});if(!e.success)return e;await this.userService.removeSubscription(),await this.userService.removeSubscriptionSlots(),await this.userService.removeSubscriptionBundle(),await this.userService.removeUser();const t=await this.apiFreeService.fetch({method:"POST",url:"apiLaunch",body:{...this.apiFreeService.deviceInfo}});if(!t.success)return await this.criticalErrorOccured({status_code:w.getStatusCodeMessage(t)}),t;await this.apiFreeService.setTokens({accessToken:t.data.accessToken,refreshToken:""});const s=await this.apiFreeService.fetch({method:"POST",url:"apiLocationList"});if(!s.success)return s;if(await this.locationService.setLocationsData(s.data),this.abTestsService.getExperimentActiveStatus(C.limitLocations))await this.locationService.setActiveLocation(O);else{const r=t.data.user.default.location;await this.locationService.setActiveLocation(r),this.webrtcService.disable().catch(()=>{})}return{success:!0,data:{success:!0}}}async showAccountPage(e){const t=await this.apiPremiumService.fetch({method:"POST",url:"apiAccountAuthToken"});return t.success?(await this.accessService.proceedToWebsiteAccount({authToken:t.data.token,route:e.route,params:e.params??{}}),{success:!0,data:{success:!0}}):t}async registerAccount(){return await this.accessService.proceedToWebsitePage({page:"pricing",params:{utm_campaign:"signup"}}),{success:!0,data:{success:!0}}}async getUserData(){return await Promise.resolve(),{success:!0,data:{user:this.userService.user,subscription:this.userService.subscription,slots:this.userService.subscriptionSlots,hasBundle:this.userService.hasBundleSubscription,canUsePremium:this.userService.canUsePremium}}}async syncSubscriptionSlots(){const e=await this.apiPremiumService.fetch({method:"GET",url:"apiSubscriptionSlot"});return e.success?(await this.userService.setSubscriptionSlots(e.data),{success:!0,data:{slots:e.data}}):e}async logoutAllDevices(){const e=await this.apiPremiumService.fetch({method:"POST",url:"apiSlotRelease"});if(!e.success)return e;const t=await this.syncSubscriptionSlots();return t.success?{success:!0,data:t.data}:t}async premiumRefreshTokenFailedListener(e){(await this.logout()).success&&this.messageService.notifyPopup({type:"authentication-change",success:!0,data:{success:!0}}),this.analyticsService.sendEvent({types:["google-analytics"],name:"premium_refresh_token_failed",data:{status_message:e.disconnectReason,status_code:e.failedReason}})}async criticalErrorOccured(e){this.analyticsService.sendEvent({types:["google-analytics"],name:"critical_error_occured",data:{...e}}),await this.globalStateService.setCriticalError(!0),await this.apiFreeService.removeTokens()}async freeRefreshTokenFailedListener(e){await this.criticalErrorOccured({status_code:"free-refresh-token-failed"}),this.messageService.notifyPopup({type:"critical-error",success:!0,data:{success:!0}}),this.analyticsService.sendEvent({types:["google-analytics"],name:"free_refresh_token_failed",data:{status_message:e.disconnectReason,status_code:e.failedReason}})}}class Ue{constructor(e,t){this.messageService=e,this.authController=t}init(){this.messageService.subscribe({"get-critical-error":this.getCriticalError.bind(this),login:this.login.bind(this),logout:this.logout.bind(this),"register-account":this.registerAccount.bind(this),"show-account-page":this.showAccountPage.bind(this),"get-user-data":this.getUserData.bind(this),"sync-subscription-slots":this.syncSubscriptionSlots.bind(this),"logout-all-devices":this.logoutAllDevices.bind(this)})}async getCriticalError(){return{...await this.authController.getCriticalError(),type:"get-critical-error"}}async login(e){return{...await this.authController.login(e),type:"login"}}async logout(){return{...await this.authController.logout(),type:"logout"}}async registerAccount(){return{...await this.authController.registerAccount(),type:"register-account"}}async showAccountPage(e){return{...await this.authController.showAccountPage(e),type:"show-account-page"}}async getUserData(){return{...await this.authController.getUserData(),type:"get-user-data"}}async syncSubscriptionSlots(){return{...await this.authController.syncSubscriptionSlots(),type:"sync-subscription-slots"}}async logoutAllDevices(){return{...await this.authController.logoutAllDevices(),type:"logout-all-devices"}}}const xe=new Fe(M,V,W,P,q,K,$,f,_,G,B),ze=new Ue(f,xe),g=class g{async setImage(e){const t=e==="connected"?g.CONNECTED_ICONS:g.DISCONNECTED_ICONS;await d.action.setIcon({path:t}),await Promise.resolve(this)}async setTooltip(e){const s=d.runtime.getManifest().name;await d.action.setTitle({title:`${s}
${e}`}),await Promise.resolve(this)}};T(g,"CONNECTED_ICONS",{16:"/icons/16.png",32:"/icons/32.png",48:"/icons/48.png",64:"/icons/64.png",128:"/icons/128.png"}),T(g,"DISCONNECTED_ICONS",{16:"/icons/16-grey.png",32:"/icons/32-grey.png",48:"/icons/48-grey.png",64:"/icons/64-grey.png",128:"/icons/128-grey.png"});let D=g;const Ne=new D,Oe=["https://captive.apple.com/"],je="https://cloudflare.com/cdn-cgi/trace",j="n/a";class Me{constructor(e,t,s,o,r,a,c,u,p,h,S,y,b,l,m,L){this.messageService=e,this.analyticsService=t,this.eventService=s,this.fetchService=o,this.connectionService=r,this.apiFreeService=a,this.apiPremiumService=c,this.userService=u,this.locationService=p,this.exclusionsService=h,this.proxyService=S,this.iconService=y,this.i18nService=b,this.appService=l,this.notificationService=m,this.lockScreenService=L,this.eventService.subscribe({"free-refresh-token-failed":this.disconnect.bind(this),"premium-refresh-token-failed":this.disconnect.bind(this)}),this.eventService.subscribe({"internet-connection-changed":this.changeInternetConnectionListener.bind(this)})}get needAuthTrigger(){return this.appService.majorBrowserVersion===0?!1:this.appService.majorBrowserVersion<122}async init(){await this.updateIcon(),(!this.locationService.locationsData||this.locationService.needUpdateLocations)&&await this.updateLocationData(),this.connectionService.currentIp||await this.updateIpAddress()}async getLocationsData(){return await Promise.resolve(),{success:!0,data:{data:this.locationService.locationsData,activeId:this.locationService.activeLocationId,favoriteIds:this.locationService.favoriteLocations}}}async getLastActiveLocation(){return await Promise.resolve(),this.locationService.lastActiveLocation?{success:!0,data:this.locationService.lastActiveLocation}:{success:!1,errors:[{code:0,status:0,name:"",message:this.i18nService.t("base:connect-errors.no-location")}]}}async updateLocations(){const e=this.userService.hasPermitions("domain","premium")?await this.apiPremiumService.fetch({method:"POST",url:"apiLocationList"}):await this.apiFreeService.fetch({method:"POST",url:"apiLocationList"});return e.success?(await this.locationService.setLocationsData(e.data),{success:!0,data:{data:this.locationService.locationsData,activeId:this.locationService.activeLocationId,favoriteIds:this.locationService.favoriteLocations}}):e}async setActiveLocation(e){return await this.locationService.setActiveLocation(e),{success:!0,data:{success:!0}}}async setFavoriteLocations(e){return e.action==="add"?await this.locationService.setFavoriteLocations(e.list):await this.locationService.removeFavoriteLocations(e.list),{success:!0,data:{success:!0}}}async connect(){const e=Date.now();if(await this.changeConnectionStatus("connecting"),!this.locationService.activeLocation)return await this.changeConnectionStatus("disconnected"),{success:!1,errors:[{code:0,status:0,name:"",message:this.i18nService.t("base:connect-errors.no-location")}]};const{name:t,region:s}=this.locationService.activeLocation,o=`${s}, ${t}`;this.analyticsService.sendEvent({types:["aws-kinesis"],name:"connection_tried",data:{event_properties__screen_name:"vpn",event_properties__location:o}}),this.analyticsService.sendEvent({types:["google-analytics","amplitude"],name:"connection_tried",data:{country:this.locationService.activeLocation.countryCode,city:this.locationService.activeLocation.name,server_type:this.locationService.activeLocation.type,server_address:"no_addresses",server_region:this.locationService.activeLocation.id}});const r={protocol:"https",region:this.locationService.activeLocation.region,type:this.locationService.activeLocation.type},a=this.userService.hasPermitions("domain","premium")?await this.apiPremiumService.fetch({method:"POST",url:"apiServerList",body:r}):await this.apiFreeService.fetch({method:"POST",url:"apiServerList",body:r});if(!a.success)return await this.changeConnectionStatus("disconnected"),this.analyticsService.sendEvent({types:["google-analytics","amplitude"],name:"connection_failed_backend",data:{country:this.locationService.activeLocation.countryCode,city:this.locationService.activeLocation.name,server_type:this.locationService.activeLocation.type,server_address:"no_addresses",server_region:this.locationService.activeLocation.id,status_code:w.getStatusCodeMessage(a)}}),this.analyticsService.sendEvent({types:["aws-kinesis"],name:"connection_failed_backend",data:{event_properties__screen_name:"vpn",event_properties__location:o,event_properties__time_to_connect:Date.now()-e,event_properties__auto_connection:"",event_properties__server_address:"no_addresses"}}),{success:!1,errors:[{code:0,status:0,name:"",message:this.i18nService.t("base:connect-errors.server-config")}]};const c=a.data.map(l=>{const m=this.appService.isBlockAds?l.rpz_port:l.port;return{addresses:l.addresses,protocol:l.protocol,port:m}}),{username:u,password:p}=a.data[0];let h=!1,S="";for(let l=0;l<c.length;l+=1){const m=c[l],L=await this.proxyService.enable({serverConfig:[m],credentials:{username:u,password:p},nonRoutableNets:this.exclusionsService.nonRoutableNets,exclusionList:this.exclusionsService.exclusionList});if(!L.status){await this.changeConnectionStatus("disconnected"),h=!1,S=L.cause==="not_controllable"?this.i18nService.t("base:connect-errors.not-controllable"):this.i18nService.t("base:connect-errors.controlled-by-other-extensions");break}const F={country:this.locationService.activeLocation.countryCode,city:this.locationService.activeLocation.name,server_type:this.locationService.activeLocation.type,server_address:m.addresses[0],server_region:this.locationService.activeLocation.id};if(this.needAuthTrigger&&!await this.triggerAuthRequiredListener()){await this.proxyService.disable(),this.analyticsService.sendEvent({types:["google-analytics"],name:"connection_failed_create_tab",data:{...F,status_code:"tab-create"}}),this.analyticsService.sendEvent({types:["aws-kinesis"],name:"connection_failed_create_tab",data:{event_properties__screen_name:"vpn",event_properties__location:o,event_properties__time_to_connect:Date.now()-e,event_properties__auto_connection:"",event_properties__server_address:m.addresses[0]}});continue}const U=await this.checkInternetConnection();if(U.success){h=!0;break}else await this.proxyService.disable(),this.analyticsService.sendEvent({types:["google-analytics"],name:"connection_failed_availability_domain_1",data:{...F,status_code:w.getStatusCodeMessage(U)}})}const y=c.flatMap(l=>l.addresses).join(", "),b={country:this.locationService.activeLocation.countryCode,city:this.locationService.activeLocation.name,server_type:this.locationService.activeLocation.type,server_address:y,server_region:this.locationService.activeLocation.id};return h?(await this.connectionService.incrementConnectionCount(),await this.updateIpAddress(),await this.changeConnectionStatus("connected"),await this.updateIcon(),await this.createDownloadNotification(),this.analyticsService.sendEvent({types:["google-analytics","amplitude"],name:"connection_succeeded",data:b}),this.analyticsService.sendEvent({types:["aws-kinesis"],name:"connection_succeeded",data:{event_properties__screen_name:"vpn",event_properties__location:o,event_properties__time_to_connect:Date.now()-e,event_properties__auto_connection:"",event_properties__server_address:y}}),{success:!0,data:{success:!0}}):(await this.changeConnectionStatus("disconnected"),await this.proxyService.disable(),this.analyticsService.sendEvent({types:["google-analytics","amplitude"],name:"connection_failed_check",data:{...b,status_code:"loop_fixed_server"}}),this.analyticsService.sendEvent({types:["aws-kinesis"],name:"connection_failed_check",data:{event_properties__screen_name:"vpn",event_properties__location:o,event_properties__time_to_connect:Date.now()-e,event_properties__auto_connection:"",event_properties__server_address:y}}),{success:!1,errors:[{code:0,status:0,name:"",message:S||this.i18nService.t("base:connect-errors.captive")}]})}async disconnect(e){if(await this.changeConnectionStatus("disconnecting"),!await this.proxyService.disable())return{success:!1,errors:[{code:0,status:0,name:"",message:this.i18nService.t("base:disconnect-errors.remove-proxy")}]};await this.updateIpAddress(),await this.changeConnectionStatus("disconnected"),await this.updateIcon();const{name:s,region:o}=this.locationService.activeLocation??{name:"",region:""},r=`${o}, ${s}`;return this.analyticsService.sendEvent({types:["aws-kinesis"],name:"disconnected",data:{event_properties__screen_name:"vpn",event_properties__location:r,event_properties__disconnect_reason:e.disconnectReason,event_properties__failed_reason:e.failedReason}}),{success:!0,data:{success:!0}}}async getConnectionState(){await Promise.resolve();const e=this.connectionService.currentIp??j;return{success:!0,data:{status:this.connectionService.status,ip:e,connectionCount:this.connectionService.connectionCount}}}async getAutoConnectSetting(){return await Promise.resolve(),{success:!0,data:{status:this.connectionService.useAutoConnect}}}async setAutoConnectSetting(e){return await this.connectionService.setAutoConnect(e.status),{success:!0,data:{success:!0}}}async updateApiDomain(){return this.apiFreeService.isDomainAvailable||await this.apiFreeService.updateDomainData(),this.apiPremiumService.isDomainAvailable||await this.apiPremiumService.updateDomainData(),{success:!0,data:{success:!0}}}async triggerAuthRequiredListener(){const e=function(s){return new Promise((o,r)=>{d.tabs.create({url:s,active:!1}).then(a=>{const c=function(h,S){S.status==="complete"&&h===a.id&&(d.tabs.onUpdated.removeListener(c),d.tabs.remove(h).catch(()=>{}),clearTimeout(u),o(a))},u=setTimeout(()=>{d.tabs.onUpdated.removeListener(c),a.id&&d.tabs.remove(a.id).catch(()=>{}),clearTimeout(u),r(new Error("triggerAuthRequiredListener timeout reject"))},5e3);d.tabs.onUpdated.addListener(c)}).catch(r)})};try{const t=this.userService.hasPermitions("domain","premium")?this.apiPremiumService.apiDomainUrl:this.apiFreeService.apiDomainUrl;return await e(t),!0}catch{return!1}}async updateIpAddress(){const e=await this.fetchService.request({method:"GET",url:je});if(e.success)try{const t=e.data.trim().split(/\n/).map(o=>o.split("=")),s=Object.fromEntries(t);await this.connectionService.setIpAddress(s.ip)}catch{this.analyticsService.sendEvent({types:["google-analytics"],name:"ip_parse_failed"})}else await this.connectionService.removeIpAddress(),this.analyticsService.sendEvent({types:["google-analytics","amplitude"],name:"ip_check_failed"})}async updateIcon(){var e;if(this.connectionService.isConnected){const t=((e=this.locationService.activeLocation)==null?void 0:e.name)??"VeePN",s=this.i18nService.t("base:connect-status.on",{tr_location:t});await this.iconService.setImage("connected"),await this.iconService.setTooltip(s)}else{const t=this.i18nService.t("base:connect-status.off");await this.iconService.setImage("disconnected"),await this.iconService.setTooltip(t)}}async updateLocationData(){const e=this.userService.hasPermitions("domain","premium")?await this.apiPremiumService.fetch({method:"POST",url:"apiLocationList"}):await this.apiFreeService.fetch({method:"POST",url:"apiLocationList"});e.success&&await this.locationService.setLocationsData(e.data)}async changeConnectionStatus(e){e==="disconnected"&&(await this.appService.setBlockAds(!1),await this.lockScreenService.removeShowState()),e==="connected"&&await this.lockScreenService.iterateShowState(),await this.connectionService.setConnectionStatus(e);const t=this.connectionService.currentIp??j;this.messageService.notifyPopup({type:"connection-change",success:!0,data:{status:this.connectionService.status,ip:t,connectionCount:this.connectionService.connectionCount}})}async createDownloadNotification(){this.connectionService.connectionCount<=3||Date.now()<this.appService.downloadNotificationTimestamp||(await this.notificationService.notify({options:{type:"image",title:this.i18nService.t("base:download-notification.title"),imageUrl:d.runtime.getURL("/images/desktop-notification.jpg"),message:this.i18nService.t("base:download-notification.message")},callback:"download-app"}),await this.appService.incrementDownloadNotificationTimestamp(),this.analyticsService.sendEvent({types:["google-analytics","amplitude"],name:"notify_popup_pc_download_shown"}))}async checkInternetConnection(){const e=await this.fetchService.request({method:"GET",url:Oe[0],cache:"no-cache"});return e.success&&e.data.toLocaleLowerCase().includes("success")?{success:!0,data:{success:!0}}:{success:!1,errors:[{code:0,status:0,name:"",message:this.i18nService.t("base:connect-errors.captive")}]}}async changeInternetConnectionListener(e){e.online?this.locationService.locationsData||await this.updateLocationData():this.connectionService.status==="connected"&&await this.disconnect({disconnectReason:"internet_connection_changed",failedReason:"n/a"}),this.messageService.notifyPopup({type:"internet-connection-changed",success:!0,data:{online:e.online}})}}class Be{constructor(e,t){this.messageService=e,this.connectionController=t}init(){this.messageService.subscribe({connect:this.connect.bind(this),disconnect:this.disconnect.bind(this),"get-connection-state":this.getConnectionState.bind(this),"get-locations-data":this.getLocationsData.bind(this),"get-last-active-location":this.getLastActiveLocation.bind(this),"update-locations-data":this.updateLocations.bind(this),"set-active-location":this.setActiveLocation.bind(this),"set-favorite-locations":this.setFavoriteLocations.bind(this),"update-api-domain":this.updateApiDomain.bind(this),"get-auto-connect-setting":this.getAutoConnectSetting.bind(this),"set-auto-connect-setting":this.setAutoConnectSetting.bind(this)})}async connect(){return{...await this.connectionController.connect(),type:"connect"}}async disconnect(e){return{...await this.connectionController.disconnect(e),type:"disconnect"}}async getConnectionState(){return{...await this.connectionController.getConnectionState(),type:"get-connection-state"}}async getLocationsData(){return{...await this.connectionController.getLocationsData(),type:"get-locations-data"}}async getLastActiveLocation(){return{...await this.connectionController.getLastActiveLocation(),type:"get-last-active-location"}}async updateLocations(){return{...await this.connectionController.updateLocations(),type:"update-locations-data"}}async setActiveLocation(e){return{...await this.connectionController.setActiveLocation(e),type:"set-active-location"}}async setFavoriteLocations(e){return{...await this.connectionController.setFavoriteLocations(e),type:"set-favorite-locations"}}async updateApiDomain(){return{...await this.connectionController.updateApiDomain(),type:"update-api-domain"}}async getAutoConnectSetting(){return{...await this.connectionController.getAutoConnectSetting(),type:"get-auto-connect-setting"}}async setAutoConnectSetting(e){return{...await this.connectionController.setAutoConnectSetting(e),type:"set-auto-connect-setting"}}}const Ve=new Me(f,$,_,J,re,V,W,P,q,Z,X,Ne,Y,ee,te,Pe),Qe=new Be(f,Ve);export{R as L,ue as R,Ve as a,ze as b,re as c,Qe as d,q as e,xe as f,A as g,Pe as l};
